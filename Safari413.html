<!doctype html>
<meta charset="utf-8">
<title>ç°¡æ˜“ç¶²è·¯é›»å°æ’­æ”¾å™¨ï¼ˆé©é… Safari 4.1.3 / macOS 10.4.11ï¼‰</title>
<style>
  body { font-family: Helvetica, Arial, sans-serif; padding: 18px; }
  h1 { font-size: 18px; margin: 0 0 8px; }
  .row { margin: 10px 0; }
  button { font-size: 14px; padding: 6px 10px; margin-right: 6px; }
  input[type="text"] { width: 98%; max-width: 720px; padding: 6px; font-size: 13px; }
  #log { margin-top: 8px; padding: 8px; background: #f4f4f4; height: 140px; overflow: auto; font: 12px/1.4 Menlo, Monaco, monospace; white-space: pre-wrap; border: 1px solid #ddd; }
  .hint { color: #555; font-size: 12px; }
  .hide { display: none; }
</style>

<h1>Baroque Stream æ’­æ”¾å™¨ï¼ˆè¶…èˆŠç‰ˆç›¸å®¹ï¼‰</h1>
<div class="hint">
  å…ˆæŒ‰ã€Œæ’­æ”¾ã€ã€‚è‹¥å‡ºç¾ NETWORK / SRC_NOT_SUPPORTEDï¼Œå¤šåŠæ˜¯èˆŠç³»çµ±ä¸æ”¯æ´è©² HTTPS æ†‘è­‰æˆ–åŠ å¯†å¥—ä»¶ï¼Œè«‹æ”¹ <b>HTTP ä¸²æµ</b>ã€‚
  ä¹Ÿå¯åœ¨ç¶²å€å¾Œé¢åŠ  <code>?url=...</code> æŒ‡å®šæ–°ä¸²æµä½å€ã€‚
</div>

<div class="row">
  <div>ä¸²æµç¶²å€ï¼š</div>
  <input id="url" type="text"
         value="https://strm112.1.fm/baroque_mobile_mp3?aw_0_req.gdpr=true">
</div>

<div class="row">
  <button id="btnPlay">â–¶ æ’­æ”¾</button>
  <button id="btnPause">â¸ æš«åœ</button>
  <button id="btnStop">â–  åœæ­¢</button>
  <button id="volDown">ğŸ”‰ éŸ³é‡ -</button>
  <button id="volUp">ğŸ”Š éŸ³é‡ +</button>
</div>

<!-- ä¸»è¦æ’­æ”¾ï¼šHTML5 audioï¼ˆè‹¥å¯ç”¨ï¼‰ -->
<audio id="player" class="hide" controls preload="none"></audio>

<!-- å¾Œå‚™æ’­æ”¾ï¼šQuickTime å¤–æ›ï¼ˆHTML5 å¤±æ•—æ™‚å‹•æ…‹ç”Ÿæˆï¼‰ -->
<div id="qtWrap" class="hide"></div>

<div id="log"></div>

<script>
// å…¨ç”¨ ES3/DOM2 å¯«æ³•ä»¥ç›¸å®¹ Safari 4.1.3ï¼ˆç„¡ let/const/ç®­é ­å‡½å¼/JSON è§£æå™¨ç­‰æ–°ç‰¹æ€§ï¼‰
(function () {
  var inputUrl = document.getElementById('url');
  var audio = document.getElementById('player');
  var qtWrap = document.getElementById('qtWrap');
  var logBox = document.getElementById('log');
  var btnPlay = document.getElementById('btnPlay');
  var btnPause = document.getElementById('btnPause');
  var btnStop = document.getElementById('btnStop');
  var btnVolDown = document.getElementById('volDown');
  var btnVolUp = document.getElementById('volUp');

  // è§£æ ?url=...ï¼ˆSafari 4 ç„¡ URLSearchParamsï¼‰
  var q = window.location.search || "";
  var urlParam = (function (s) {
    if (!s || s.length < 2) return "";
    s = s.substring(1);
    var parts = s.split("&");
    for (var i = 0; i < parts.length; i++) {
      var kv = parts[i].split("=");
      if (kv[0] === "url") {
        try { return decodeURIComponent(kv[1].replace(/\+/g, " ")); } catch (e) { return kv[1]; }
      }
    }
    return "";
  })(q);
  if (urlParam) inputUrl.value = urlParam;

  function log(msg) {
    logBox.innerHTML += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  function show(el) { el.className = el.className.replace(/\bhide\b/, ""); }
  function hide(el) { if (el.className.indexOf("hide") < 0) el.className += " hide"; }

  function canPlayMP3() {
    var test = document.createElement('audio');
    return !!(test && test.canPlayType && test.canPlayType('audio/mpeg'));
  }

  // åˆå§‹åŒ–ï¼šè‹¥æ”¯æ´ <audio> æ’­ MP3ï¼Œå…ˆç”¨ HTML5ï¼›å¦å‰‡å¾…æœƒç›´æ¥ fallback
  var html5Capable = canPlayMP3();
  if (html5Capable) {
    show(audio);
    audio.preload = "none";

    // è¨­å®šäº‹ä»¶ï¼ˆå”åŠ©æ’éŒ¯ï¼‰
    if (audio.addEventListener) {
      audio.addEventListener('play', function(){ log('audio: play'); }, false);
      audio.addEventListener('playing', function(){ log('audio: playing'); }, false);
      audio.addEventListener('pause', function(){ log('audio: pause'); }, false);
      audio.addEventListener('waiting', function(){ log('audio: waiting (buffering)'); }, false);
      audio.addEventListener('stalled', function(){ log('audio: stalled'); }, false);
      audio.addEventListener('canplay', function(){ log('audio: canplay'); }, false);
      audio.addEventListener('canplaythrough', function(){ log('audio: canplaythrough'); }, false);
      audio.addEventListener('error', function(){
        var code = audio.error && audio.error.code;
        var map = {1:"ABORTED",2:"NETWORK",3:"DECODE",4:"SRC_NOT_SUPPORTED"};
        log('audio: error code=' + code + ' (' + (map[code] || 'unknown') + ')  â†’ ä½¿ç”¨ QuickTime å¤–æ›å¾Œå‚™');
        fallbackToQuickTime(inputUrl.value);
      }, false);
    }
  }

  function fallbackToQuickTime(u) {
    hide(audio);
    var html = ''
      + '<object type="audio/mpeg" data="' + u + '" width="320" height="18">'
      +   '<param name="src" value="' + u + '"/>'
      +   '<param name="autoplay" value="true"/>'
      +   '<param name="controller" value="true"/>'
      +   '<embed src="' + u + '" type="audio/mpeg" autoplay="true" controller="true" width="320" height="18"></embed>'
      + '</object>';
    qtWrap.innerHTML = html;
    show(qtWrap);
    log('fallback: QuickTime plugin modeï¼ˆè‹¥ HTTPS ä»å¤±æ•—ï¼Œè«‹æ”¹ HTTP ä¸²æµï¼‰');
  }

  function startPlay() {
    var u = inputUrl.value || "";
    if (!u) { log("è«‹è¼¸å…¥ä¸²æµç¶²å€"); return; }

    // å…ˆç”¨ HTML5 è©¦æ’­ï¼›ä¸è¡Œå† fallback
    if (html5Capable) {
      try {
        hide(qtWrap);
        audio.pause && audio.pause();
        audio.removeAttribute && audio.removeAttribute('src');
        audio.load && audio.load();
        audio.src = u;
        // Safari 4 å° play() çš„ Promise ä¸æ”¯æ´ï¼Œç›´æ¥å‘¼å«å³å¯
        audio.play && audio.play();
        log("audio: play() å·²å‘¼å«");
      } catch (e) {
        log("audio: play() ä¾‹å¤– â†’ ä½¿ç”¨ QuickTime å¤–æ›ï¼›è¨Šæ¯ï¼š" + e);
        fallbackToQuickTime(u);
      }
    } else {
      fallbackToQuickTime(u);
    }
  }

  function pausePlay() {
    if (html5Capable && audio && audio.pause) {
      try { audio.pause(); } catch (e) {}
    } else {
      log("å¤–æ›æ¨¡å¼è«‹ç”¨å¤–æ›æ§åˆ¶åˆ—æš«åœ/æ’­æ”¾");
    }
  }

  function stopPlay() {
    if (html5Capable && audio) {
      try {
        audio.pause && audio.pause();
        audio.removeAttribute && audio.removeAttribute('src');
        audio.load && audio.load();
        log("audio: å·²åœæ­¢ä¸¦é‡ç½®");
      } catch (e) { log("stop error: " + e); }
    } else {
      // å¤–æ›ï¼šç§»é™¤å†é‡å»ºï¼ˆç­‰ä¸‹æ¬¡æ’­æ”¾æ™‚å»ºç«‹ï¼‰
      qtWrap.innerHTML = "";
      hide(qtWrap);
      log("å¤–æ›ï¼šå·²ç§»é™¤ã€‚æŒ‰ã€æ’­æ”¾ã€æœƒé‡æ–°å»ºç«‹å¤–æ›ã€‚");
    }
  }

  btnPlay.onclick = startPlay;
  btnPause.onclick = pausePlay;
  btnStop.onclick = stopPlay;

  // ç°¡æ˜“éŸ³é‡ï¼ˆåªå° HTML5 audio æœ‰æ•ˆï¼›å¤–æ›è«‹ç”¨ç³»çµ±/å¤–æ›æ§åˆ¶ï¼‰
  btnVolDown.onclick = function () {
    if (html5Capable && audio && typeof audio.volume === "number") {
      var v = audio.volume - 0.1; if (v < 0) v = 0;
      audio.volume = v;
      log("éŸ³é‡ï¼š" + (Math.round(v * 100)) + "%");
    }
  };
  btnVolUp.onclick = function () {
    if (html5Capable && audio && typeof audio.volume === "number") {
      var v = audio.volume + 0.1; if (v > 1) v = 1;
      audio.volume = v;
      log("éŸ³é‡ï¼š" + (Math.round(v * 100)) + "%");
    }
  };
})();
</script>
